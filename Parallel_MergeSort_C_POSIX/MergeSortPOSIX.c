#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <sys/time.h>

#define N 2  /* # of thread */
#define THRESHOLD 500

int a[] = {236994, 559385, 650314, 75859, 792327, 296218, 861264, 243018, 820565, 580104, 821167, 492342, 510163, 412464, 718744, 643648, 387057, 569208, 735872, 29675, 143973, 863421, 165168, 682869, 857744, 737931, 950584, 261670, 615999, 114552, 347524, 525944, 404942, 435997, 963910, 637154, 565224, 793586, 13139, 994243, 683689, 170565, 564938, 655400, 52324, 736407, 763439, 900986, 600128, 999507, 389014, 64071, 232957, 962668, 45114, 959595, 502293, 589393, 374189, 516954, 83645, 149136, 600490, 644429, 182986, 432324, 104070, 141639, 221425, 96508, 879045, 273667, 77671, 964778, 827273, 700860, 321767, 975109, 597925, 968536, 157906, 852988, 676240, 587186, 868912, 550614, 466741, 550339, 835924, 399851, 375655, 994348, 467998, 347896, 584242, 219554, 18394, 794979, 230029, 719478, 686598, 895308, 477867, 531072, 450930, 813644, 158320, 521703, 95871, 37325, 689217, 14928, 433545, 713030, 463668, 406497, 56673, 707153, 431143, 154417, 179251, 589162, 280812, 703054, 476999, 158086, 854178, 760234, 18851, 121230, 298079, 952482, 608717, 635318, 438153, 671020, 963181, 252479, 84676, 462365, 912273, 256901, 607429, 933333, 96779, 377413, 317253, 273032, 819189, 9519, 955218, 212329, 635861, 923684, 190912, 883700, 116635, 967437, 236988, 139480, 471239, 293527, 473856, 61632, 72423, 577998, 634210, 503421, 80510, 380309, 553736, 752338, 410497, 188032, 200182, 524571, 281402, 230158, 411656, 528794, 149648, 253190, 89467, 458655, 164830, 405164, 370213, 634196, 7871, 131488, 866117, 448675, 511531, 465940, 169461, 930052, 773434, 777128, 86460, 445222, 44424, 197284, 150912, 214137, 896114, 107345, 630232, 330646, 316924, 19828, 712832, 493260, 458068, 893352, 620006, 433480, 783665, 939607, 695585, 844384, 469974, 996885, 493505, 569404, 549875, 262553, 643457, 644769, 140074, 195544, 286105, 600603, 760495, 233216, 217072, 438407, 476808, 219342, 240175, 154874, 609588, 302476, 430897, 76050, 123368, 981483, 967702, 275927, 94452, 880760, 811831, 403340, 275589, 629758, 859059, 237400, 781379, 223993, 389224, 422988, 300378, 638834, 751358, 477841, 528279, 85180, 157085, 717039, 257448, 85001, 986047, 232444, 989446, 872809, 681311, 808543, 474478, 920609, 869649, 992576, 620298, 91940, 545259, 904782, 655855, 925616, 271009, 758636, 66560, 786056, 955375, 344569, 94447, 542153, 557039, 19258, 707171, 762604, 615882, 861670, 237878, 688343, 959627, 702030, 206805, 729184, 965391, 487208, 556811, 748383, 675993, 40695, 817815, 366126, 473922, 886744, 526329, 71488, 276685, 152106, 315724, 88219, 489112, 665243, 350605, 410483, 612079, 333260, 707193, 490468, 525499, 878304, 204309, 824268, 865176, 244198, 509191, 157636, 826436, 301280, 164258, 624377, 945459, 353648, 416255, 109674, 559871, 53022, 544710, 324160, 609596, 42888, 792076, 379653, 391530, 870631, 657750, 562946, 812291, 288505, 464764, 254586, 339765, 10961, 388841, 124348, 35818, 759223, 753215, 317033, 743426, 539453, 107479, 426947, 754338, 681119, 14438, 253485, 199718, 832662, 193147, 591621, 612466, 949177, 369700, 91610, 630438, 860048, 179505, 243148, 490095, 712055, 661648, 321343, 172666, 59692, 959063, 756731, 84228, 22389, 146017, 910564, 396558, 813617, 911247, 521616, 689708, 855161, 840816, 813322, 239099, 666482, 790459, 461411, 485618, 770546, 775673, 670831, 550674, 740300, 88448, 837347, 353975, 515066, 559705, 630345, 189777, 133030, 21059, 992925, 896748, 182485, 456209, 907400, 490474, 861616, 649966, 704438, 39763, 920112, 257, 292054, 790979, 919078, 176107, 868653, 76738, 251941, 205293, 432152, 956400, 331021, 271079, 975004, 528671, 389748, 898939, 867179, 903355, 674802, 288976, 736118, 843556, 852233, 501555, 219881, 498396, 252591, 277655, 702408, 250140, 671994, 720445, 312804, 246785, 681383, 578799, 825465, 914212, 67143, 19558, 335655, 756295, 927175, 136523, 900683, 666858, 982938, 574874, 703418, 622398, 925381, 235299, 530842, 364977, 9223, 426283, 659804, 611112, 834850, 997999, 881561, 610059, 996362, 85000, 963208, 895161, 649641, 738602, 240986, 749148, 459725, 717638, 135858, 717208, 962415, 630544, 597508, 226973, 26465, 830171, 69577, 388125, 657299, 38495, 50524, 224791, 841601, 869597, 170356, 279824, 988221, 677913, 159295, 73635, 230100, 347974, 821527, 798960, 247776, 828160, 351843, 504496, 987114, 57011, 520845, 780713, 125817, 353305, 116571, 789820, 591291, 94752, 111661, 580764, 312591, 462313, 935570, 656025, 214957, 440173, 820806, 290906, 717043, 399290, 895436, 376426, 223565, 153307, 922788, 828905, 120511, 529302, 210538, 503907, 724050, 448591, 107083, 749757, 961241, 496906, 821412, 959563, 265758, 118158, 762424, 364607, 414510, 983396, 756494, 173757, 273278, 467391, 240357, 303689, 384121, 825333, 667413, 352546, 459367, 466476, 145156, 373736, 608251, 843344, 235201, 336632, 667257, 434112, 489600, 694808, 174786, 272200, 223987, 852558, 777725, 972425, 800001, 615051, 962724, 850549, 811237, 247685, 857320, 156663, 716646, 371106, 867074, 966703, 893358, 932560, 904216, 731227, 699850, 239729, 207176, 187601, 399037, 354996, 115859, 503912, 533377, 926335, 137449, 606327, 317467, 752328, 318797, 994357, 782874, 807811, 488420, 523136, 949419, 739829, 508000, 505145, 151644, 21480, 2819, 82380, 404715, 858295, 884690, 320269, 590346, 743049, 11097, 192894, 964786, 807898, 154901, 964269, 301857, 719477, 997761, 493050, 918770, 705214, 148928, 532919, 759639, 69995, 707363, 393960, 263477, 620243, 156376, 105193, 813019, 708703, 676464, 980335, 448544, 209245, 212427, 341862, 429849, 573235, 73123, 689146, 309812, 188656, 245425, 210546, 226677, 408830, 956927, 515702, 475210, 962036, 386763, 250481, 436876, 356872, 218389, 374929, 388501, 349730, 660294, 191851, 910200, 438027, 361853, 132796, 992161, 998724, 718774, 962379, 907914, 71539, 879897, 555498, 812567, 186168, 270493, 468122, 300048, 464350, 801111, 55630, 626168, 164206, 145763, 614728, 187214, 430749, 381613, 963424, 87199, 351269, 798685, 127139, 933190, 760241, 371933, 478744, 457474, 647025, 300488, 313694, 680754, 574734, 582128, 627697, 927791, 817719, 785868, 906443, 220934, 773850, 949052, 607847, 418193, 441263, 888763, 395361, 868337, 776238, 242080, 491577, 959913, 305057, 694289, 579318, 365146, 777940, 913605, 655463, 404823, 491624, 629619, 400196, 812580, 624711, 435804, 470004, 643216, 197809, 759346, 351656, 916716, 488373, 305892, 363940, 889575, 900028, 513863, 514974, 63943, 154112, 18658, 307199, 472454, 179418, 759446, 171654, 543239, 200056, 852392, 851916, 581107, 174380, 439853, 943458, 509813, 47330, 32401, 335190, 288526, 488618, 834883, 790613, 436885, 41459, 115968, 320426, 955535, 861657, 724155, 322980, 684710, 156949, 834598, 399254, 76298, 699795, 906784, 793464, 89505, 892129, 477819, 705643, 302956, 163907, 575144, 808282, 184311, 93283, 125314, 341884, 660412, 421093, 830643, 989813, 451158, 247641, 170887, 268828, 917597, 457610, 128779, 256408, 474850, 887027, 849825, 726051, 613896, 324689, 446500, 446065, 293757, 860372, 716978, 207017, 851348, 24111, 934938, 948178, 613249, 448207, 376099, 905417, 401776, 677544, 81975, 389358, 988802, 58474, 532907, 213087, 953445, 137043, 660524, 760220, 198798, 86942, 216647, 20682, 881750, 306841, 699476, 136531, 680942, 247828, 61376, 647018, 652224, 334261, 410614, 866796, 460708, 141289, 533418, 418722, 925948, 583221, 600066, 628195, 684269, 430506, 966433, 668695, 649210, 434999, 692048, 339798, 995134, 523288, 339083, 848238, 27654, 228652, 231590, 920835, 14217, 444197, 294810, 670481, 435845, 486041, 456880, 467982, 961335, 2997, 728009, 88619, 947893, 339280, 42823, 311672, 42028, 818077, 15644, 487271, 995890, 102971, 403245, 225768, 279815, 110503, 119138, 689332, 425837, 655569, 352909, 511142, 384353, 44236, 999924, 791107, 247541, 935902, 366973, 650714, 900299, 890487, 36853, 152967, 945968, 630143, 436028, 508497, 364306, 712648, 822929, 464755, 559007, 631075, 428982};

int threadCount = 0;
int startThread = 0;

typedef struct Arr
{
    int low;
    int high;
} ArrayIndex;

long long current_timestamp()
{
    struct timeval te;
    gettimeofday(&te, NULL);
    return te.tv_sec*1000LL + te.tv_usec;
}

void merge(int low, int high)
{
    int mid = (low + high)/2;
    int left = low;
    int right = mid+1;
    
    int newArr[high-low+1], newLeft = 0;
    
    while(left <= mid && right <= high)
    {
        if (a[left] > a[right]) { newArr[newLeft++] = a[right++]; }
        else { newArr[newLeft++] = a[left++]; }
    }
    
    while(left <= mid) { newArr[newLeft++] = a[left++]; }
    
    while(right <= high) { newArr[newLeft++] = a[right++]; }
    
    for (left = 0; left < (high-low+1) ; left++) { a[low+left] = newArr[left]; }
}

void linear_mergesort(int low, int high)
{
    if (low < high)
    {
        int m = (high + low)/2;
        linear_mergesort(low, m);
        linear_mergesort(m + 1, high);
        merge(low, high);
    }
}

void * merge_sort(void *p)
{
    ArrayIndex *pa = (ArrayIndex *)p;
    int mid = (pa->low + pa->high)/2;
    
    int ret;
    ArrayIndex aIndex[N];
    pthread_t thread[N];
    
    aIndex[0].low = pa->low;
    aIndex[0].high = mid;
    
    aIndex[1].low = mid+1;
    aIndex[1].high = pa->high;
	
	if(pa->high - pa->low <= THRESHOLD)
    {
		linear_mergesort(pa->low, pa->high);
	}
    else
    {
        if (pa->low >= pa->high) {return NULL;}
		
		int i;
		for(i = 0; i < N; i++)
		{
			ret = pthread_create(&thread[i], NULL, merge_sort, &aIndex[i]);
            threadCount++;
			if (ret)
			{
				printf("%d %s - unable to create thread - ret - %d\n", __LINE__, __FUNCTION__, ret);
				exit(1);
			}
		}
		for(i = 0; i < N; i++) {pthread_join(thread[i], NULL);}
    }
    
    merge(pa->low, pa->high);
    pthread_exit(NULL);
}

int main()
{
    long long t0 = current_timestamp();
    int arr_size = sizeof(a)/sizeof(a[0]);
    ArrayIndex ai;
    ai.low = 0;
    ai.high = arr_size-1;
    pthread_t thread;
    int ret;
    
    ret = pthread_create(&thread, NULL, merge_sort, &ai);
    threadCount++;
    if (ret)
    {
        printf("%d %s - unable to create thread - ret - %d\n", __LINE__, __FUNCTION__, ret);
        exit(1);
    }

    pthread_join(thread, NULL);
    
    int i;
    for (i = 0; i < arr_size; i++)
    {
      if(i == arr_size - 1){printf("%d ", a[i]);}
      else{printf ("%d, ", a[i]);}
    }
	
    long long t1 = current_timestamp();
    long long t = t1 - t0;
    printf("\n+===============================+\n");
    printf("|           STATISTIC           |");
    printf("\n+===============================+\n");
    printf("  Time for execution:    %lldμs \n", t);
    printf("  Threads generated:     %d     \n", threadCount);
    printf("  Threads for each part: %d     \n", N);
    printf("  Threshold:             %d     \n", THRESHOLD);
    printf("  Elements sorted:       %d     \n", arr_size);
    printf("+===============================+\n");
    
    return 0;
}